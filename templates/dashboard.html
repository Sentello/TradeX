<!DOCTYPE html>
<html lang="en" data-bs-theme="dark">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>TradeX Bot Dashboard</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>
    <div class="container-fluid mt-4">
        <h1 class="text-center text-success mb-4">ðŸ’° TradeX Bot Dashboard</h1>

        {% if error %}
        <div class="alert alert-danger text-center" role="alert">
            <strong>Error:</strong> {{ error }}
        </div>
        {% endif %}

        <div class="card mb-4">
            <div class="card-header">
                <h2><i class="bi bi-graph-up"></i> Summary Statistics</h2>
            </div>
            <div class="card-body">
                <div class="row text-center">
                    <div class="col-md-4">
                        <h4><i class="bi bi-wallet2"></i> Portfolio Value</h4>
                        <p id="portfolio-value" class="fs-4">Loading...</p>
                    </div>
                    <div class="col-md-4">
                        <h4><i class="bi bi-bar-chart-line"></i> Total PNL</h4>
                        <p id="total-pnl" class="fs-4">Loading...</p>
                    </div>
                    <div class="col-md-4">
                        <h4><i class="bi bi-credit-card"></i> Margin Used</h4>
                        <p id="margin-used" class="fs-4">Loading...</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2><i class="bi bi-list-task"></i> Open Positions</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Side</th>
                                <th>Contracts</th>
                                <th>Notional</th>
                                <th>Entry Price</th>
                                <th>Liq. Price</th>
                                <th>Margin Ratio</th>
                                <th>Leverage</th>
                                <th>Unrealized PNL</th>
                                <th>Exchange</th>
                                <th>Close</th>
                            </tr>
                        </thead>
                        <tbody id="positions-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2><i class="bi bi-hourglass-split"></i> Pending Orders</h2>
            </div>
            <div class="card-body">
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th>Symbol</th>
                                <th>Type</th>
                                <th>Side</th>
                                <th>Price</th>
                                <th>Quantity</th>
                                <th>Exchange</th>
                                <th>Action</th>
                            </tr>
                        </thead>
                        <tbody id="pending-orders-body">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="card mb-4">
            <div class="card-header">
                <h2><i class="bi bi-file-earmark-text"></i> Logs</h2>
            </div>
            <div class="card-body">
                <div class="mb-3">
                    <select id="log-file-select" class="form-select"></select>
                </div>
                <textarea id="logs-textarea" class="form-control" rows="10" readonly></textarea>
            </div>
        </div>

        <div class="text-center mb-4">
            <form method="POST" action="/close_all_positions" onsubmit="return confirm('Close all open positions?')">
                <button type="submit" class="btn btn-warning btn-lg"><i class="bi bi-x-circle"></i> Close All Open Positions</button>
            </form>
        </div>
    </div>

    <footer class="text-center text-muted py-4">
        &copy; TradeX Bot | <a href="https://github.com/Sentello/TradeX">GitHub</a>
    </footer>

    <script>
        // Fetch and display positions
        async function fetchPositions() {
            try {
                const response = await fetch('/positions');
                const positionsData = await response.json();

                const positionsBody = document.querySelector('#positions-body');
                positionsBody.innerHTML = ''; // Clear the table

                for (const exchange in positionsData) {
                    const positions = positionsData[exchange];

                    positions.forEach(position => {
                        const pnlClass = position.unrealized_pnl >= 0 ? 'text-success' : 'text-danger';
                        const row = `
                            <tr>
                                <td>${position.symbol}</td>
                                <td>${position.side}</td>
                                <td>${position.contracts}</td>
                                <td>${position.notional.toFixed(2)}</td>
                                <td>${position.entry_price.toFixed(4)}</td>
                                <td>${position.liquidation_price === null ? 'N/A' : position.liquidation_price}</td>
                                <td>${position.margin_ratio ? position.margin_ratio.toFixed(2) : 'N/A'}</td>
                                <td>${position.leverage || 'N/A'}</td>
                                <td class="${pnlClass}">${position.unrealized_pnl.toFixed(2)}</td>
                                <td>${position.exchange}</td>
                                <td>
                                    <form method="POST" action="/close_position" onsubmit="return confirm('Close position for ${position.symbol}?')">
                                        <input type="hidden" name="EXCHANGE" value="${position.exchange}">
                                        <input type="hidden" name="SYMBOL" value="${position.symbol}">
                                        <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-x-lg"></i> Close</button>
                                    </form>
                                </td>
                            </tr>
                        `;
                        positionsBody.innerHTML += row;
                    });
                }
            } catch (error) {
                console.error('Error fetching positions:', error.message);
            }
        }

        // Fetch and display pending orders
        async function fetchPendingOrders() {
            try {
                const response = await fetch('/pending_orders');
                const pendingOrdersData = await response.json();

                const pendingOrdersBody = document.querySelector('#pending-orders-body');
                pendingOrdersBody.innerHTML = ''; // Clear the table

                for (const exchange in pendingOrdersData) {
                    const orders = pendingOrdersData[exchange];

                    orders.forEach(order => {
                        const row = `
                            <tr>
                                <td>${order.symbol}</td>
                                <td>${order.type}</td>
                                <td>${order.side}</td>
                                <td>${order.price !== null ? order.price : (order.triggerPrice || 'N/A')}</td>
                                <td>${order.amount || order.info.qty || 'N/A'}</td>
                                <td>${exchange}</td>
                                <td>
                                    <form action="/cancel_order" method="POST">
                                        <input type="hidden" name="EXCHANGE" value="${exchange}">
                                        <input type="hidden" name="ORDER_ID" value="${order.id}">
                                        <input type="hidden" name="SYMBOL" value="${order.symbol}">
                                        <button type="submit" class="btn btn-danger btn-sm"><i class="bi bi-trash"></i> Cancel</button>
                                    </form>
                                </td>
                            </tr>
                        `;
                        pendingOrdersBody.innerHTML += row;
                    });
                }
            } catch (error) {
                console.error('Error fetching pending orders:', error.message);
            }
        }

        // Fetch and display summary stats
        async function fetchSummaryStats() {
            try {
                const response = await fetch('/summary_stats');
                const summaryData = await response.json();

                document.querySelector('#portfolio-value').textContent = `$${summaryData.portfolio_value.toFixed(2)}`;
                document.querySelector('#total-pnl').textContent = `$${summaryData.total_pnl.toFixed(2)}`;
                document.querySelector('#margin-used').textContent = `$${summaryData.margin_used.toFixed(2)}`;
            } catch (error) {
                console.error('Error fetching summary stats:', error);
            }
        }

        // Fetch and display logs
        async function fetchLogs() {
            try {
                const response = await fetch('/logs');
                const logsData = await response.json();
                const logsTextArea = document.getElementById('logs-textarea');
                const logFileSelect = document.getElementById('log-file-select');

                if (logsData.status === 'success') {
                    logFileSelect.innerHTML = '';
                    let defaultOption = document.createElement('option');
                    defaultOption.value = '';
                    defaultOption.textContent = 'Select a log file';
                    logFileSelect.appendChild(defaultOption);

                    for (const logFile in logsData.logs) {
                        const option = document.createElement('option');
                        option.value = logFile;
                        option.textContent = logFile;
                        logFileSelect.appendChild(option);
                    }

                    logFileSelect.value = Object.keys(logsData.logs)[0] || '';
                    displayLogs(logFileSelect.value, logsData.logs);

                    logFileSelect.addEventListener('change', () => {
                        displayLogs(logFileSelect.value, logsData.logs);
                    });

                } else {
                    logsTextArea.value = 'Error fetching logs: ' + logsData.message;
                }
            } catch (error) {
                console.error('Error fetching logs:', error.message);
                document.getElementById('logs-textarea').value = 'Error fetching logs: ' + error.message;
            }
        }

        function displayLogs(selectedLogFile, allLogs) {
            try {
                const logsTextArea = document.getElementById('logs-textarea');

                if (selectedLogFile && allLogs[selectedLogFile]) {
                    logsTextArea.value = allLogs[selectedLogFile].join('');
                } else {
                    logsTextArea.value = 'Select a log file to view.';
                }
            } catch (error) {
                console.error('Error displaying logs:', error.message);
            }
        }

        // Initial load
        window.onload = () => {
            fetchPositions();
            fetchPendingOrders();
            fetchSummaryStats();
            fetchLogs();
        };

        setInterval(() => {
            fetchPositions();
            fetchPendingOrders();
            fetchSummaryStats();
        }, 15000);
    </script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>